sap.ui.define(["./BaseController","sap/ui/model/json/JSONModel","../model/formatter","sap/ui/model/Filter","sap/ui/model/FilterOperator","sap/m/MessageToast","sap/m/MessagePopover","sap/m/MessageItem","sap/m/Button","sap/m/MessageBox","sap/ui/export/library","sap/ui/export/Spreadsheet"],function(e,t,r,s,a,o,i,n,l,p,u,d){"use strict";var g;return e.extend("UploadProfit.UploadProftCenterAssignment.controller.Worklist",{formatter:r,onInit:function(){this._oTable=this.byId("profitTable");this._tModel=new sap.ui.model.json.JSONModel;this._rModel=new sap.ui.model.json.JSONModel;this._dModel=this.getOwnerComponent().getModel();this._oPromises=[];this._msgArr=[];this._aObj=[];this._msgData={msgs:this._msgArr};this._rData={trec:this._aObj};var e=this.byId("cUpload");e.setEnabled(false);var t=this.byId("DExcel");t.setEnabled(false)},handleUploadPress:function(){var e=this;var t;t=this._oTable;var r=[];var s={trec:r};var a=this.byId("fileUploader");if(!a.getValue()){o.show("Select the file first!");return}else{var i=a.getFocusDomRef();var n=i.files[0];if(n&&window.FileReader){var l=new FileReader;l.onload=function(a){var o=a.target.result;var i=o.replace(/\n/g,",").split(",");var n;n=6;var l=i.splice(0,n);while(i.length-1>0){var p={};var u={};var d=i.splice(0,n);for(var g=0;g<d.length;g++){var h=d[g].trim();switch(g){case 0:u["Operation"]=h;break;case 1:u["CCode"]=h;break;case 2:u["CGroup"]=h;break;case 3:u["MGroup"]=h;break;case 4:u["PCenter"]=h;break;case 5:u["EDate"]=h;break}}r.push(u)}e._tModel.setData(s);t.setModel(e._tModel);var c=e.byId("cUpload");c.setEnabled(true);e.byId("fileUploader").setEnabled(false);e.byId("tUpload").setEnabled(false)};l.readAsBinaryString(n)}}},handlePost:function(){var e=this;var t=0;sap.ui.core.BusyIndicator.show();Promise.allSettled=function(r){r.forEach(function(r){r.then(function(s){t=t+1;e._sMCount=t;if(t===e._oPromises.length){e.promiseCompleted()}return r},function(s){t=t+1;if(t===e._oPromises.length){e.promiseCompleted()}return r})});return r};var r=[];r=this.uploadProfitCenterData();var s=Promise.allSettled(r)},handleRefresh:function(){this._tModel.setData();this._rModel.setData();this._sMCount=0;this._oPromises=[];this._bPromises=[];this._msgArr=[];this._aObj=[];this._msgData.msgs={};this._rData.trec={};this.byId("cUpload").setEnabled(false);this.byId("tUpload").setEnabled(true);this.byId("fileUploader").setEnabled(true);this.byId("fileUploader").clear();this.byId("DExcel").setEnabled(false);var e=sap.ui.getCore().byId("logBut");if(typeof e!=="undefined"){e.destroy()}},uploadProfitCenterData:function(){var e=[];var t;var r=this._tModel.getData();for(var s=0;s<r.trec.length;s++){var a={};a["Operation"]=r.trec[s].Operation;a["CCode"]=r.trec[s].CCode;a["CGroup"]=r.trec[s].CGroup;a["MGroup"]=r.trec[s].MGroup;a["PCenter"]=r.trec[s].PCenter;a["EDate"]=r.trec[s].EDate;if(r.trec[s].Operation=="C"||r.trec[s].Operation=="c"){t=this.createPCData(r.trec[s],s,a)}if(r.trec[s].Operation=="U"||r.trec[s].Operation=="u"){t=this.updatePCData(r.trec[s],s,a)}e.push(t)}return e},createPCData:function(e,t,r){var s={};var a="BatchReq";a=a+t;s.YY1_FIN_CF_COMPANY_CODE=e.CCode.toUpperCase();s.YY1_FIN_CF_CUSTOMER_GR=e.CGroup.toUpperCase();s.YY1_FIN_CF_MATERIAL_GRP=e.MGroup.toUpperCase();s.YY1_FIN_CF_PROFIT_CENTER=e.PCenter.toUpperCase();e.EDate=e.EDate+"T00:00:00";s.YY1_FIN_CF_EXP_DATE=e.EDate;var o=this._dModel;var i=this;var n=new Promise(function(e,t){o.create("/YY1_FIN_CB_PROFIT_CENTER",s,{success:function(t){var s={};s["Mtype"]="Success";var a=i.getView().getModel("i18n").getResourceBundle().getText("sMsg");s["Msg"]=a;r["msg"]=s["Msg"];i._msgArr.push(s);i._aObj.push(r);e()},error:function(e){var s={};s["Mtype"]="Error";s["Msg"]=e.responseText;r["msg"]=s["Msg"];i._aObj.push(r);i._msgArr.push(s);t()},groupId:a})});this._oPromises.push(n);return n},displayLog:function(){var e=this.byId("DExcel");e.setEnabled(true);var t;t=this._oTable;this._rData.trec=this._aObj;this._msgData.msgs=this._msgArr;this._rModel.setData(this._rData);t.setModel(this._rModel);var r=new n({type:"{type}",title:"{title}",activeTitle:"{active}",description:"{description}",subtitle:"{subtitle}",counter:"{counter}"});g=new i({items:{path:"/",template:r},activeTitlePress:function(){}});var s=0;var a=0;var o=[];for(var p=0;p<this._msgArr.length;p++){var u={};if(this._msgArr[p].Mtype=="Success"){u["type"]=this._msgArr[p].Mtype;u["title"]="Success Message";u["active"]=false;u["description"]=this._msgArr[p].Msg;u["subtitle"]=this.getView().getModel("i18n").getResourceBundle().getText("sMsg");s=s+1;u["conunter"]=s}else{u["type"]=this._msgArr[p].Mtype;u["title"]="Error Message";u["active"]=true;u["description"]=this._msgArr[p].Msg;u["subtitle"]=this.getView().getModel("i18n").getResourceBundle().getText("eMsg");a=a+1;u["conunter"]=s}o.push(u)}var d=new sap.ui.model.json.JSONModel;d.setData(o);this.getView().setModel(d);var h=new l({id:"logBut",text:"Log",type:"Emphasized",width:"6rem"});h.addDependent(g);h.attachPress(this.handleMessagePopoverPress);var c=this.getView().byId("oToolBar");c.addContent(h);this.byId("cUpload").setEnabled(false);this.byId("tUpload").setEnabled(false);this.byId("fileUploader").setEnabled(false)},promiseCompleted:function(){sap.ui.core.BusyIndicator.hide();this.displayLog()},handleMessagePopoverPress:function(e){g.toggle(e.getSource())},updatePCData:function(e,t,r){var o={};var i={};var n=[];var l={};var p="BatchReq";p=p+t;var u=e.CCode.toUpperCase();l=new s("YY1_FIN_CF_COMPANY_CODE",a.EQ,u);n.push(l);var d=e.CGroup.toUpperCase();l=new s("YY1_FIN_CF_CUSTOMER_GR",a.EQ,d);n.push(l);var g=e.MGroup.toUpperCase();l=new s("YY1_FIN_CF_MATERIAL_GRP",a.EQ,g);n.push(l);i.YY1_FIN_CF_PROFIT_CENTER=e.PCenter.toUpperCase();e.EDate=e.EDate+"T00:00:00";i.YY1_FIN_CF_EXP_DATE=e.EDate;var h=this.updatePCAssignment(r,i,n);this._oPromises.push(h);return h},updatePCAssignment:function(e,t,r){var s=this;var a=this._dModel;var o=new Promise(function(o,i){var n=new Promise(function(t,o){a.read("/YY1_FIN_CB_PROFIT_CENTER",{success:function(r){var a="results";if(a in r){if(r.results.length!==0){var o=r.results[0].SAP_UUID;t(o)}else{var i={};i["Mtype"]="Error";var n=s.getView().getModel("i18n").getResourceBundle().getText("eeMsg");i["Msg"]=n;e["msg"]=i["Msg"];s._aObj.push(e);s._msgArr.push(i);t("Error")}}else{var i={};i["Mtype"]="Error";var n=s.getView().getModel("i18n").getResourceBundle().getText("eeMsg");i["Msg"]=n;e["msg"]=i["Msg"];s._aObj.push(e);s._msgArr.push(i);t("Error")}},error:function(r){var a={};a["Mtype"]="Error";a["Msg"]=r.responseText;e["msg"]=a["Msg"];s._aObj.push(e);s._msgArr.push(a);t("Error")},filters:r})});n.then(function(n){if(n==="Error"){i()}else{var l=a.createKey("/YY1_FIN_CB_PROFIT_CENTER",{SAP_UUID:n});a.update(l,t,{success:function(t){var r={};r["Mtype"]="Success";var a=s.getView().getModel("i18n").getResourceBundle().getText("sMsg");r["Msg"]=a;e["msg"]=r["Msg"];s._msgArr.push(r);s._aObj.push(e);o()},error:function(t){var r={};r["Mtype"]="Error";r["Msg"]=t.responseText;e["msg"]=r["Msg"];e["success"]=" ";s._aObj.push(e);s._msgArr.push(r);i()},filters:r})}})});return o},downloadData:function(){var e=[];var t;var r={trec:e};var r=this._rModel.getData();var s;if(typeof r==="undefined"){s=true}else{if(Object.keys(r).length===0){s=true}}if(s){var a=this.getView().getModel("i18n").getResourceBundle().getText("oTableNoDataText");sap.m.MessageBox.warning(a)}else{var i,n,l,p;i=this.createColumns();n=this._rModel.getProperty("/trec");l={workbook:{columns:i},dataSource:n};p=new d(l);p.build().then(function(){o.show("Spreadsheet export has finished")}).finally(p.destroy)}},createColumns:function(){var e=[];var t=this.getView().getModel("i18n").getResourceBundle().getText("PI");var r=this.getView().getModel("i18n").getResourceBundle().getText("Comp");var s=this.getView().getModel("i18n").getResourceBundle().getText("CGRP");var a=this.getView().getModel("i18n").getResourceBundle().getText("MGRP");var o=this.getView().getModel("i18n").getResourceBundle().getText("Pcenter");var i=this.getView().getModel("i18n").getResourceBundle().getText("Edate");var n=this.getView().getModel("i18n").getResourceBundle().getText("msg");e.push({label:t,property:"Operation",width:10,type:"string"});e.push({label:r,property:"CCode",width:10,type:"string"});e.push({label:s,property:"CGroup",width:10,type:"string"});e.push({label:a,property:"MGroup",width:10,type:"string"});e.push({label:o,property:"PCenter",width:10,type:"string"});e.push({label:i,property:"EDate",width:10,type:"string"});e.push({label:n,property:"msg",width:10,type:"string"});return e},onUpdateFinished:function(e){},onPress:function(e){},onShareInJamPress:function(){},onSearch:function(e){},onRefresh:function(){},_showObject:function(e){},_applySearch:function(e){}})});